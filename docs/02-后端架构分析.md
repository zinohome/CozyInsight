# DataEase 后端架构详细分析

## 技术栈

### 核心框架
- **Spring Boot**: 3.3.0
- **Java 版本**: 21 (LTS)
- **Spring Cloud**: 2023.0.1
- **Spring Cloud Alibaba**: 2023.0.1.0

### 数据访问层
- **ORM 框架**: MyBatis Plus 3.5.6
- **数据库**:
  - H2 2.2.220 (桌面版/开发环境)
  - MySQL 8.2.0 (生产环境)
- **连接池**: Apache Commons DBCP2 2.6.0
- **数据库迁移**: Flyway (自动化 Schema 管理)

### SQL 引擎
- **Apache Calcite**: 1.35.23 (SQL 解析与优化)
- **Apache SeaTunnel**: 数据集成

### 缓存
- **Ehcache**: 3.10.8 (本地缓存)
- **Redis**: 分布式缓存(可选)

### 任务调度
- **Quartz**: 定时任务调度框架

### API 文档
- **Knife4j**: 4.4.0 (Swagger UI增强)
- **SpringDoc OpenAPI**: API 文档自动生成

### 其他关键依赖
- **JWT**: 3.12.1 (身份验证)
- **Guava**: 33.0.0-jre (Google 工具库)
- **EasyExcel**: 3.3.4 (Excel 处理)
- **Commons IO**: 2.16.1 (IO 工具)
- **Velocity**: 2.3 (模板引擎)
- **BouncyCastle**: 1.78 (加密库)
- **Selenium**: 4.19.1 (截图/浏览器自动化)
- **iText PDF**: 8.0.4 (PDF 生成)
- **WebSocket**: 实时双向通信

## 后端模块结构 (27个核心模块)

### 1. 数据相关模块

#### `datasource` - 数据源管理
**职责**:
- 数据源连接配置(MySQL、Oracle、SQL Server、PostgreSQL等)
- 数据源驱动管理
- 数据源状态监控
- 连接测试与验证

**核心功能**:
- 支持20+主流数据库
- 自定义驱动上传
- 连接池管理
- 数据源加密存储

#### `dataset` - 数据集管理
**职责**:
- 数据集创建与编辑
- SQL 数据集
- Union 数据集
- Excel/API 数据集
- 数据集字段管理

**核心功能**:
- 直连/同步模式
- 数据集目录树管理
- 字段类型转换
- 计算字段
- 数据集关联

#### `engine` - 数据引擎
**职责**:
- SQL 查询引擎
- 数据计算与聚合
- Apache Calcite 集成
- 查询优化

**核心功能**:
- 跨数据源查询
- SQL 方言转换
- 查询缓存
- 性能优化

### 2. 可视化模块

#### `chart` - 图表管理
**职责**:
- 图表配置管理
- 图表渲染逻辑
- 图表类型定义
- 图表样式配置

**核心功能**:
- 40+ 图表类型(柱状图、折线图、饼图、地图等)
- 自定义图表样式
- 图表联动
- 图表跳转
- 图表刷新

#### `visualization` - 可视化管理
**职责**:
- 仪表板管理
- 大屏管理
- 可视化布局
- 组件管理

**核心功能**:
- 拖拽式布局
- 组件联动
- 外部参数
- 跳转配置
- 水印管理

### 3. 系统管理模块

#### `system` - 系统管理
**职责**:
- 系统参数配置
- 用户管理
- 角色管理
- 组织管理
- 许可证管理

**核心功能**:
- 系统配置
- 用户权限
- 组织架构
- 操作审计

#### `menu` - 菜单管理
**职责**:
- 菜单配置
- 权限路由
- 菜单授权

#### `license` - 许可证管理
**职责**:
- License 验证
- 功能权限控制
- 版本管理

### 4. 任务与调度

#### `job` - 定时任务
**职责**:
- 定时任务调度
- 数据同步任务
- 报告推送任务
- 任务执行日志

**核心功能**:
- Cron 表达式配置
- 简单重复任务
- 任务执行监控
- 任务失败重试

#### `exportCenter` - 导出中心
**职责**:
- 报告导出
- 图片导出
- Excel 导出
- PDF 导出

**核心功能**:
- 导出任务管理
- 导出格式支持
- 导出记录查询

### 5. 分享与协作

#### `share` - 分享管理
**职责**:
- 仪表板分享
- 链接分享
- 嵌入分享
- 分享权限控制

**核心功能**:
- 公开链接分享
- 密码保护
- 有效期控制
- 访问统计

#### `msgCenter` - 消息中心
**职责**:
- 系统通知
- 任务通知
- 消息推送

### 6. 高级功能

#### `ai` - AI 智能分析
**职责**:
- SQL 智能生成
- 智能问答
- 数据洞察

**核心功能**:
- 自然语言转 SQL
- 智能推荐
- 数据分析建议

#### `template` - 模板管理
**职责**:
- 仪表板模板
- 模板市场
- 模板导入导出

#### `map` - 地图可视化
**职责**:
- 地图数据管理
- 地理编码
- 区域映射

### 7. 其他支撑模块

#### `commons` - 公共模块
**职责**:
- 公共工具类
- 常量定义
- 异常处理
- 基础配置

#### `config` - 配置模块
**职责**:
- Spring 配置
- MyBatis 配置
- WebSocket 配置
- 缓存配置
- 跨域配置

#### `interceptor` - 拦截器
**职责**:
- 权限拦截
- 日志拦截
- 请求拦截

#### `listener` - 监听器
**职责**:
- 应用启动监听
- 缓存初始化
- 事件监听

#### `startup` - 启动模块
**职责**:
- 应用初始化
- 数据初始化
- 系统检查

#### `websocket` - WebSocket
**职责**:
- 实时通信
- 消息推送
- 长连接管理

#### `font` - 字体管理
**职责**:
- 自定义字体
- 字体上传

#### `resource` - 资源管理
**职责**:
- 文件上传
- 图片管理
- 静态资源

#### `operation` - 操作日志
**职责**:
- 用户操作记录
- 审计日志

#### `substitute` - 替补实现
**职责**:
- 权限替补实现(桌面版/社区版)

#### `defeign` - Feign 客户端
**职责**:
- 微服务调用(分布式版)

#### `home` - 首页
**职责**:
- 首页数据聚合
- 工作台

## 架构模式

### 分层架构

```
┌─────────────────────────────────────┐
│         Controller Layer            │ (控制层 - REST API)
├─────────────────────────────────────┤
│          Service Layer              │ (业务层 - 业务逻辑)
├─────────────────────────────────────┤
│            DAO Layer                │ (数据访问层 - MyBatis)
├─────────────────────────────────────┤
│         Database Layer              │ (数据库层 - MySQL/H2)
└─────────────────────────────────────┘
```

### 模块化设计

- **SDK 层**: 提供基础 API 定义和接口
- **Core 层**: 核心业务实现
- **Distributed 层**: 分布式扩展(企业版)

### 配置管理

#### 多环境配置
1. **application.yml** - 基础配置
2. **application-standalone.yml** - 单机版配置
3. **application-desktop.yml** - 桌面版配置
4. **application-distributed.yml** - 分布式版配置

#### Profile 激活
- Maven Profile 控制编译时配置
- Spring Profile 控制运行时配置

## 数据访问层设计

### MyBatis Plus 集成

**优势**:
- 简化 CRUD 操作
- 内置分页插件
- 代码生成器
- 条件构造器

### Mapper 映射
- **Auto Mapper**: MyBatis Plus 自动生成
- **Ext Mapper**: 自定义复杂查询(XML 文件)

**示例 Ext Mapper**:
- `ExtVisualizationLinkJumpMapper.xml`
- `ExtVisualizationLinkageMapper.xml`
- `ExtCoreChartMapper.xml`
- `ExtDataVisualizationMapper.xml`

### 数据库迁移 (Flyway)

**版本管理**:
- `db/desktop/` - 桌面版迁移脚本
- `db/migration/` - 通用迁移脚本

**命名规范**:
- `V2.0__core_ddl.sql` - 初始 schema
- `V2.3__ddl.sql` - 版本更新
- `V2.10.7__ddl.sql` - 补丁更新

## API 设计

### RESTful API

**URL 规范**:
- `/api/dataset/*` - 数据集 API
- `/api/datasource/*` - 数据源 API
- `/api/chart/*` - 图表 API
- `/api/visualization/*` - 可视化 API

### 统一响应格式
```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

### 权限控制
- **注解驱动**: `@PreAuthorize`
- **拦截器**: 请求权限检查
- **JWT Token**: 身份验证

## 缓存策略

### 两级缓存

1. **Ehcache** (一级缓存)
   - 本地缓存
   - 配置文件管理
   - 快速访问

2. **Redis** (二级缓存 - 可选)
   - 分布式缓存
   - Session 共享
   - 集群支持

### 缓存场景
- 数据源配置
- 用户权限
- 菜单树
- 字典数据

## WebSocket 实时通信

**应用场景**:
- 任务执行状态推送
- 数据同步进度
- 实时通知

## 任务调度 (Quartz)

**任务类型**:
1. **数据同步任务**: 定时同步数据集
2. **报告推送任务**: 定时生成并推送报告
3. **清理任务**: 定时清理过期数据

**调度配置**:
- Cron 表达式
- 简单重复 (分钟/小时/天)
- 触发器管理

## 安全机制

### 加密存储
- **RSA**: 非对称加密
- **AES**: 对称加密
- **BouncyCastle**: 加密算法库

### 数据安全
- 数据源密码加密
- 敏感字段加密
- 传输加密 (HTTPS)

### 水印
- 明水印
- 暗水印
- 自定义水印内容

## 总结

### 架构优势
✅ **模块化设计**: 27个清晰的业务模块,职责分明
✅ **技术栈现代**: Spring Boot 3.x + Java 21 + MyBatis Plus
✅ **可扩展性强**: 支持 standalone/desktop/distributed 三种模式
✅ **性能优化**: 多级缓存、查询优化、连接池管理
✅ **安全可靠**: JWT认证、数据加密、权限控制

### 值得学习的设计
1. **多Profile部署模式**: 通过Maven和Spring Profile实现多环境
2. **数据库迁移管理**: Flyway版本化管理
3. **模块化分层**: 清晰的DDD领域划分
4. **SQL引擎抽象**: Apache Calcite实现跨数据源查询
5. **任务调度设计**: Quartz集成与分布式任务管理
