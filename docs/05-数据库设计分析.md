# DataEase 数据库设计分析

## 数据库技术栈

### 支持的数据库
- **H2**: 2.2.220 (桌面版/开发环境)
- **MySQL**: 8.2.0 (生产环境)

### 数据库迁移管理
- **Flyway**: 自动化数据库版本管理
- **Schema 版本化**: `V2.0__core_ddl.sql`, `V2.3__ddl.sql`, `V2.10.7__ddl.sql` 等

## 核心数据表分析

根据代码分析,该系统包含约 50+ 核心数据表,按业务领域划分如下:

### 1. 数据源管理

#### `core_datasource` - 数据源配置表
**用途**: 存储各类数据源的连接配置

**核心字段**:
- `id`: 主键 ID
- `name`: 数据源名称
- `description`: 描述
- `type`: 数据源类型(MySQL, Oracle, PostgreSQL, ClickHouse等)
- `pid`: 父级 ID(用于数据源分组)
- `edit_type`: 更新方式(0:替换, 1:追加)
- `configuration`: 连接配置详情(JSON longtext)
- `create_time`, `update_time`: 创建/更新时间
- `create_by`: 创建人 ID
- `status`: 状态
- `qrtz_instance`: Quartz 实例
- `task_status`: 任务状态

**特点**:
- 敏感信息(密码)加密存储
- 支持层级分组管理
- 记录任务状态和调度信息

#### `core_driver` - 驱动管理表
**用途**: 管理数据库驱动程序

**核心字段**:
- `id`: 主键
- `name`: 驱动名称
- `type`: 数据源类型
- `driver_class`: 驱动类名
- `description`: 描述
- `create_time`: 创建时间

#### `core_driver_jar` - 驱动JAR文件表
**用途**: 存储驱动 JAR 包信息

**核心字段**:
- `id`: 主键
- `de_driver_id`: 关联驱动 ID
- `file_name`: 文件名
- `version`: 版本号
- `driver_class`: 驱动类列表(longtext)
- `trans_name`, `is_trans_name`: 转换名称相关

---

### 2. 数据集管理

#### `core_dataset_group` - 数据集分组表
**用途**: 数据集的树形组织结构

**核心字段**:
- `id`: 主键 ID
- `name`: 名称
- `pid`: 父级 ID
- `level`: 层级深度
- `node_type`: 节点类型(folder 或 dataset)
- `type`: 数据集类型(sql, union, excel, api 等)
- `mode`: 连接模式(0:直连, 1:同步)
- `info`: 关联关系树(longtext JSON)
- `create_by`: 创建人
- `create_time`, `last_update_time`: 时间戳
- `qrtz_instance`: Quartz 实例
- `sync_status`: 同步状态
- `union_sql`: 关联 SQL

**设计模式**:
- 树形结构(ID-PID模型)
- 支持文件夹和数据集两种节点类型
- 直连/同步双模式

#### `core_dataset_table` - 数据集表信息
**用途**: 数据集关联的物理表或查询

**核心字段**:
- `id`: 主键
- `name`: 名称
- `table_name`: 物理表名
- `datasource_id`: 数据源 ID
- `dataset_group_id`: 所属数据集 ID
- `type`: 类型(db, sql, union, excel, api)
- `info`: 表详细信息(SQL/配置等)
- `sql_variable_details`: SQL 参数变量

#### `core_dataset_table_field` - 数据集字段表
**用途**: 数据集字段元数据管理

**核心字段**:
- `id`: 主键
- `datasource_id`: 数据源 ID
- `dataset_table_id`: 数据表 ID
- `dataset_group_id`: 数据集 ID
- `chart_id`: 图表 ID(可选)
- `origin_name`: 原始字段名
- `name`: 展示名称
- `description`: 描述
- `dataease_name`: DE 唯一标识字段名
- `field_short_name`: 字段别名
- `group_type`: 维度/指标标识(d:维度, q:指标)
- `type`: 原始字段类型
- `size`: 字段大小
- `de_type`: DataEase 字段类型(0-文本, 1-时间, 2-整型, 3-浮点, 4-布尔, 5-地理位置等)
- `de_extract_type`: 原始类型记录
- `ext_field`: 扩展字段标识(0:原始, 1:复制, 2:计算字段)
- `checked`: 是否选中
- `column_index`: 列位置
- `last_sync_time`: 同步时间
- `accuracy`: 精度
- `date_format`, `date_format_type`: 日期格式

**特点**:
- 支持原始字段、复制字段、计算字段
- 维度和指标分离
- 类型映射与转换
- 字段精度控制

---

### 3. 可视化模块

#### `data_visualization_info` - 可视化对象表
**用途**: 仪表板/大屏的元数据

**核心字段**:
- `id`: ID(varchar 50)
- `name`: 名称
- `pid`: 父 ID
- `org_id`: 组织 ID
- `level`: 层级
- `node_type`: 节点类型(folder/panel)
- `type`: 类型
- `canvas_style_data`: 画布样式数据(longtext JSON)
- `component_data`: 组件数据(longtext JSON)
- `mobile_layout`: 移动端布局
- `status`: 状态(0:未发布, 1:已发布)
- `self_watermark_status`: 独立水印状态
- `sort`: 排序
- `create_time`, `update_time`: 时间戳
- `create_by`, `update_by`: 创建/更新人
- `remark`: 备注
- `source`: 数据来源
- `delete_flag`, `delete_time`, `delete_by`: 逻辑删除

**设计特点**:
- 大字段存储(canvas_style_data, component_data)
- 支持发布/未发布状态
- 逻辑删除(软删除)
- 移动端适配

#### `core_chart_view` - 图表视图表
**用途**: 图表的详细配置

**核心字段**:
- `id`: 主键
- `title`: 图表标题
- `scene_id`: 场景 ID(仪表板 ID)
- `table_id`: 数据集表 ID
- `type`: 图表类型(柱状图、折线图、饼图等)
- `render`: 渲染方式
- `result_count`, `result_mode`: 结果展示配置
- `x_axis`: 横轴字段(longtext JSON)
- `x_axis_ext`: 表格行字段
- `y_axis`: 纵轴字段(longtext JSON)
- `y_axis_ext`: 副轴字段
- `ext_stack`, `ext_bubble`, `ext_label`, `ext_tooltip`: 扩展配置
- `custom_attr`: 图形属性(longtext JSON)
- `custom_style`: 组件样式(longtext JSON)
- `custom_filter`: 结果过滤(longtext JSON)
- `drill_fields`: 钻取字段(longtext JSON)
- `senior`: 高级配置(longtext JSON)
- `create_by`, `create_time`, `update_time`: 元信息
- `snapshot`: 缩略图(longtext)
- `style_priority`: 样式优先级(panel/view)
- `chart_type`: 图表归属类型(public/private)
- `is_plugin`: 是否插件
- `data_from`: 数据来源(template/dataset)
- `view_fields`: 图表字段集合(longtext JSON)
- `refresh_view_enable`, `refresh_unit`, `refresh_time`: 刷新配置
- `linkage_active`, `jump_active`: 联动/跳转开关
- `copy_from`, `copy_id`: 复制来源

**设计亮点**:
- JSON 大字段存储复杂配置
- 支持公共/私有图表
- 支持复制与模板
- 自动刷新配置
- 联动跳转功能

---

### 4. 任务调度

#### `core_datasource_task` - 数据源任务表
**用途**: 数据同步定时任务

**核心字段**:
- `id`: 主键
- `ds_id`: 数据源 ID
- `name`: 任务名称
- `update_type`: 更新方式
- `start_time`: 开始时间
- `sync_rate`: 执行频率(0:一次性, 1:cron)
- `cron`: Cron 表达式
- `simple_cron_value`, `simple_cron_type`: 简单重复配置
- `end_limit`, `end_time`: 结束限制
- `create_time`: 创建时间
- `last_exec_time`, `last_exec_status`: 上次执行信息
- `extra_data`: 扩展数据
- `task_status`: 任务状态

**调度策略**:
- 一次性任务
- Cron 表达式定时
- 简单重复(分钟/小时/天)

#### `core_datasource_task_log` - 任务执行日志表
**用途**: 记录任务执行历史

**核心字段**:
- `id`: 主键
- `ds_id`: 数据源 ID
- `task_id`: 任务ID
- `start_time`, `end_time`: 执行时间范围
- `task_status`: 执行状态
- `table_name`: 表名
- `info`: 错误信息(longtext)
- `create_time`: 创建时间
- `trigger_type`: 触发类型

**索引**:
- `idx_dataset_table_task_log_ds_id`
- `idx_dataset_table_task_log_task_id`

---

### 5. 系统管理

#### `core_menu` - 菜单表
**用途**: 系统菜单权限配置

**核心字段**:
- `id`: 主键
- `pid`: 父菜单 ID
- `type`: 类型
- `name`: 菜单名称
- `component`: Vue 组件路径
- `menu_sort`: 排序
- `icon`: 图标
- `path`: 路由路径
- `hidden`: 是否隐藏
- `in_layout`: 是否布局内
- `auth`: 是否参与授权

**预置菜单**:
- workbranch - 工作台
- panel - 仪表板
- screen - 大屏
- data - 数据管理(datasource, dataset)
- sys-setting - 系统设置

#### `core_rsa` - RSA密钥表
**用途**: 加密密钥存储

**核心字段**:
- `id`: 主键
- `private_key`: 私钥(text)
- `public_key`: 公钥(text)
- `create_time`: 生成时间
- `aes_key`: AES 密钥

仅有一条记录,系统级密钥。

#### `core_de_engine` - 数据引擎配置表
**用途**: 数据处理引擎配置

**核心字段**:
- `id`: 主键
- `name`, `description`: 名称描述
- `type`: 引擎类型
- `configuration`: 引擎配置(longtext)
- `create_time`, `update_time`: 时间戳
- `create_by`: 创建人
- `status`: 状态

---

### 6. 地理与区域

#### `area` - 地区表
**用途**: 中国行政区划数据

**核心字段**:
- `id`: 区域 ID(对应 GeoJSON 文件)
- `level`: 区域级别(country, province, city, district)
- `name`: 区域名称
- `pid`: 父级区域 ID

**数据规模**:
- 国家级: 1条(中国)
- 省级: 约34个
- 市级、区县级: 数百至数千条

**用途**:
- 地图可视化
- 地理编码
- 区域筛选

---

### 7. 其他核心表

#### `core_store` - 存储管理表(推测)
用于管理文件存储配置

#### `core_chart` 相关快照表
- `snapshot_core_chart_view`
- `snapshot_visualization_*`

用于保存仪表板快照,支持版本回溯和分享。

#### 可视化配置表
- `visualization_background` - 背景配置
- `visualization_subject` - 主题配置
- `visualization_watermark` - 水印配置
- `visualization_linkage` - 联动配置
- `visualization_linkage_field` - 联动字段
- `visualization_link_jump` - 跳转配置
- `visualization_outer_params` - 外部参数

---

## 数据库设计模式

### 1. 树形结构设计
**应用场景**:
- 数据源分组: `core_datasource.pid`
- 数据集分组: `core_dataset_group.pid + level`
- 菜单: `core_menu.pid`
- 可视化分组: `data_visualization_info.pid + level`

**实现方式**:
- ID-PID (Parent ID) 模式
- Level 字段记录层级深度
- 支持递归查询

### 2. JSON 大字段设计
**应用场景**:
- 配置存储: `configuration` (longtext)
- 样式数据: `canvas_style_data`, `custom_style`
- 组件数据: `component_data`
- 字段配置: `x_axis`, `y_axis`, `drill_fields` 等

**优点**:
- 灵活的schema less design
- 易于扩展
- 配置项版本化

**缺点**:
- 查询性能较差
- 索引困难

### 3. 软删除(逻辑删除)
**应用场景**:
- `data_visualization_info`: `delete_flag`, `delete_time`, `delete_by`

**优点**:
- 数据可恢复
- 审计追溯
- 避免外键约束问题

### 4. 时间戳审计
**标准字段**:
- `create_time`: 创建时间(bigint毫秒级)
- `update_time`: 更新时间
- `create_by`: 创建人
- `update_by`: 更新人

使用 bigint 存储毫秒级时间戳,便于跨时区处理。

### 5. 快照模式
**应用场景**:
- 分享功能: 生成快照,避免源数据变更影响分享内容
- 版本管理: 历史版本保存

**表前缀**: `snapshot_*`

### 6. 多态关联
**示例**: `core_dataset_table_field.chart_id`

同一个字段可能关联数据集,也可能关联图表,实现灵活的字段复用。

---

## 索引策略

### 已识别的索引

#### 任务日志表索引
```sql
KEY `idx_dataset_table_task_log_ds_id` (`ds_id`)
KEY `idx_dataset_table_task_log_task_id` (`task_id`)
```

### 推荐添加的索引

1. **数据集相关**:
   - `core_dataset_group(pid)` - 树形查询
   - `core_dataset_table(datasource_id, dataset_group_id)` - 关联查询
   - `core_dataset_table_field(dataset_table_id, dataset_group_id)` - 字段查询

2. **可视化相关**:
   - `data_visualization_info(pid, delete_flag)` - 树形+逻辑删除
   - `data_visualization_info(create_by, create_time)` - 用户查询
   - `core_chart_view(scene_id, table_id)` - 图表关联

3. **任务调度**:
   - `core_datasource_task(ds_id, task_status)` - 任务查询

---

## 数据库设计亮点

### ✅ 优点

1. **灵活的配置存储**: 使用 JSON longtext 存储复杂配置,扩展性强

2. **树形结构支持**: ID-PID + Level 实现多级分类

3. **软删除**: 数据安全,可恢复

4. **快照机制**: 支持版本管理和分享

5. **时间戳审计**: 完整的创建人、更新人、时间追溯

6. **多模式支持**: 直连/同步双模式,灵活适配不同场景

7. **地理数据内置**: 内置中国行政区划,便于地理可视化

### ⚠️ 需要注意的点

1. **大字段性能**: JSON longtext 字段较多,查询性能需要优化

2. **索引不足**: 部分关联字段缺少索引

3. **范式化程度**: 部分冗余字段,但符合 BI 系统的读多写少特点

4. **时间戳类型**: 使用 bigint 而非 TIMESTAMP/DATETIME,需要应用层处理

5. **字符编码**: 需确保 UTF-8 支持多语言

---

## 数据量估算

### 典型企业场景(中型)

| 表名 | 记录数 | 说明 |
|------|--------|------|
| core_datasource | 50-100 | 数据源数量 |
| core_dataset_group | 500-1000 | 数据集分组 |
| core_dataset_table | 1000-2000 | 数据集表 |
| core_dataset_table_field | 10000-50000 | 字段数量 |
| data_visualization_info | 1000-5000 | 仪表板/大屏 |
| core_chart_view | 5000-20000 | 图表数量 |
| core_datasource_task_log | 百万级+ | 任务日志(需定期清理) |

---

## 数据库迁移策略

### Flyway 版本管理

**命名规范**:
- `V{version}__{description}.sql`
- 示例: `V2.0__core_ddl.sql`, `V2.10.7__ddl.sql`

**迁移目录**:
- `db/desktop/` - 桌面版
- `db/migration/` - 通用迁移

**版本升级**:
- 从 v2.0 → v2.10.17 共约 20+ 个迁移脚本
- 自动检测并执行未运行的迁移

---

## 总结

DataEase 的数据库设计体现了以下特点:

✅ **面向 BI 场景**: 大量 JSON 字段存储复杂配置,适应 BI 的灵活性需求

✅ **元数据驱动**: 数据集、字段、图表配置全部元数据化

✅ **树形组织**: 多级分类组织,符合企业数据管理习惯

✅ **审计友好**: 时间戳、创建人、软删除,完整的审计链路

✅ **快照机制**: 支持版本管理和数据分享

⚠️ **性能优化空间**: JSON大字段、索引优化、分区策略可进一步提升

⚠️ **归档策略**: 日志表需要定期归档/清理

这是一个典型的元数据驱动型 BI 系统数据库设计,在灵活性和性能间取得了平衡。
